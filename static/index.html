<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFSIM RAGä»£ç ç”Ÿæˆç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
            height: 100vh;
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }
        h1 { color: #667eea; margin-bottom: 20px; font-size: 24px; }
        h2 { color: #764ba2; margin: 15px 0 10px; font-size: 18px; }
        .btn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover { background: #e0e0e0; }
        .input-group {
            margin: 10px 0;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 12px;
            background: #f7f7f7;
            border-left: 4px solid #667eea;
        }
        .info-display {
            font-size: 12px;
            white-space: pre-wrap;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            max-width: 85%;
        }
        .user-message {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .bot-message {
            background: #e8eaf6;
            color: #333;
        }
        .message pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .message code {
            background: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .message strong {
            color: #667eea;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .examples {
            margin-top: 10px;
        }
        .example-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #e8eaf6;
            border: 1px solid #c5cae9;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            transition: all 0.2s;
        }
        .example-btn:hover {
            background: #d1c4e9;
            border-color: #9575cd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>âš™ï¸ ç³»ç»Ÿæ§åˆ¶</h1>
            
            <button class="btn btn-primary" onclick="initializeSystem()">ğŸš€ åˆå§‹åŒ–ç³»ç»Ÿ</button>
            <div id="init-status" class="status" style="display: none;"></div>
            
            <h2>ğŸ“ æ–‡æ¡£åŠ è½½</h2>
            <div class="input-group">
                <input type="text" id="docs-path" placeholder="æ–‡æ¡£æ–‡ä»¶å¤¹è·¯å¾„æˆ–æ–‡ä»¶åˆ—è¡¨" value="tutorials">
            </div>
            <button class="btn btn-secondary" onclick="loadDocuments()">ğŸ“‚ åŠ è½½æ–‡æ¡£</button>
            <div id="load-status" class="status" style="display: none;"></div>
            
            <h2>ğŸ’¡ ç¤ºä¾‹æŸ¥è¯¢</h2>
            <div class="examples">
                <button class="example-btn" onclick="useExample('è¯·å®šä¹‰ä¸€ä¸ªè“æ–¹çš„å¦å…‹å¹³å°ç±»å‹')">å¦å…‹å¹³å°å®šä¹‰</button>
                <button class="example-btn" onclick="useExample('å®šä¹‰ä¸€æ¶è“æ–¹æ— äººæœº')">å®šä¹‰æ— äººæœº</button>
                <button class="example-btn" onclick="useExample('å®šä¹‰ä¸€ä¸ªæˆ˜æ–—æœºå¹³å°ç±»å‹ F-35_Type')">å®šä¹‰æˆ˜æ–—æœºå¹³å°ç±»å‹</button>
                <button class="example-btn" onclick="useExample('å®šä¹‰ä¸€è‰˜çº¢æ–¹é©±é€èˆ°')">å®šä¹‰é©±é€èˆ°</button>
                <button class="example-btn" onclick="useExample('å®šä¹‰ä¸€ä¸ªè“æ–¹å¯¼å¼¹å‘å°„è½¦')">å¯¼å¼¹å‘å°„è½¦å®šä¹‰</button>
            </div>
            
            <h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
            <button class="btn btn-secondary" onclick="refreshSystemInfo()">ğŸ”„ åˆ·æ–°ä¿¡æ¯</button>
            <div id="info-display" class="info-display"></div>
            
            <h2>ğŸ› ï¸ è°ƒè¯•</h2>
            <button class="btn btn-secondary" onclick="showDebugInfo()">ğŸ” è°ƒè¯•ä¿¡æ¯</button>
        </div>
        
        <div class="main-content">
            <h1>ğŸ’¬ AFSIMåŠ©æ‰‹</h1>
            <div id="chat-container" class="chat-container"></div>
            
            <div class="input-group" style="display: flex; gap: 10px;">
                <textarea id="message-input" placeholder="è¾“å…¥ä½ çš„AFSIMç›¸å…³é—®é¢˜..." rows="2"></textarea>
                <button class="btn btn-primary" onclick="sendMessage()" style="width: auto; padding: 10px 20px;">
                    å‘é€
                </button>
            </div>
            
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
                <button class="btn btn-secondary" onclick="exportChat()">å¯¼å‡ºå†å²</button>
            </div>
        </div>
    </div>

    <script>
        let currentConversationId = 'default';
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            const btn = document.querySelector('.btn-primary');
            const status = document.getElementById('init-status');
            const spinner = document.createElement('span');
            spinner.className = 'loading';
            
            btn.disabled = true;
            btn.appendChild(spinner);
            status.style.display = 'block';
            status.textContent = 'æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...';
            
            try {
                const response = await fetch('/api/init', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    status.textContent = `âœ… ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼\nâ€¢ æ¨¡å‹: ${result.model}\nâ€¢ åµŒå…¥æ¨¡å‹: ${result.embed_model}\nâ€¢ æ–‡æ¡£æ•°é‡: ${result.doc_count}`;
                } else {
                    status.textContent = `âŒ åˆå§‹åŒ–å¤±è´¥: ${result.detail}`;
                }
            } catch (error) {
                status.textContent = `âŒ é”™è¯¯: ${error.message}`;
            } finally {
                btn.disabled = false;
                spinner.remove();
            }
        }
        
        // åŠ è½½æ–‡æ¡£
        async function loadDocuments() {
            const path = document.getElementById('docs-path').value;
            const status = document.getElementById('load-status');
            const btn = document.querySelector('[onclick="loadDocuments()"]');
            const spinner = document.createElement('span');
            spinner.className = 'loading';
            
            btn.disabled = true;
            btn.appendChild(spinner);
            status.style.display = 'block';
            status.textContent = 'æ­£åœ¨åŠ è½½æ–‡æ¡£...';
            
            try {
                const response = await fetch('/api/load-docs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({file_list_path: path})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    status.textContent = `âœ… æ–‡æ¡£åŠ è½½å®Œæˆï¼\nâ€¢ åŠ è½½æ–¹å¼: ${result.method}\nâ€¢ æ–‡æ¡£å—æ€»æ•°: ${result.total_chunks}`;
                } else {
                    status.textContent = `âŒ åŠ è½½å¤±è´¥: ${result.detail}`;
                }
            } catch (error) {
                status.textContent = `âŒ é”™è¯¯: ${error.message}`;
            } finally {
                btn.disabled = false;
                spinner.remove();
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const query = input.value.trim();
            
            if (!query) return;
            
            const container = document.getElementById('chat-container');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(query, 'user');
            input.value = '';
            
            // æ·»åŠ åŠ è½½æŒ‡ç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message';
            loadingDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨æ€è€ƒ...';
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        conversation_id: currentConversationId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    loadingDiv.remove();
                    addMessage(result.response, 'bot');
                } else {
                    loadingDiv.textContent = `âŒ é”™è¯¯: ${result.detail}`;
                }
            } catch (error) {
                loadingDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
            
            container.scrollTop = container.scrollHeight;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨
        function addMessage(text, sender) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            // æ ¼å¼åŒ–ä»£ç å—
            text = text.replace(/```afsim/g, '<pre><code>').replace(/```/g, '</code></pre>');
            text = text.replace(/`/g, '<code>');
            
            messageDiv.innerHTML = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // ä½¿ç”¨ç¤ºä¾‹
        function useExample(text) {
            document.getElementById('message-input').value = text;
        }
        
        // åˆ·æ–°ç³»ç»Ÿä¿¡æ¯
        async function refreshSystemInfo() {
            const display = document.getElementById('info-display');
            display.textContent = 'æ­£åœ¨è·å–ç³»ç»Ÿä¿¡æ¯...';
            
            try {
                const response = await fetch('/api/system-info');
                const result = await response.json();
                
                if (response.ok) {
                    display.textContent = `æ¨¡å‹: ${result.model.path || 'æœªè®¾ç½®'}\nåµŒå…¥æ¨¡å‹: ${result.model.embed_model || 'æœªè®¾ç½®'}\næ–‡æ¡£æ•°é‡: ${result.document.count}\nWebç«¯å£: ${result.system.web_port}\nCPU: ${result.system.cpu_usage}%\nå†…å­˜: ${result.system.memory_usage}%`;
                } else {
                    display.textContent = `è·å–å¤±è´¥: ${result.detail}`;
                }
            } catch (error) {
                display.textContent = `é”™è¯¯: ${error.message}`;
            }
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        async function showDebugInfo() {
            const display = document.getElementById('info-display');
            display.textContent = 'æ­£åœ¨è·å–è°ƒè¯•ä¿¡æ¯...';
            
            try {
                const response = await fetch('/api/debug-info');
                const result = await response.json();
                
                if (response.ok) {
                    display.textContent = `ç³»ç»Ÿå·²åˆå§‹åŒ–: ${result.system_initialized}\né›†åˆåç§°: ${result.collection.name || 'N/A'}\næ–‡æ¡£æ•°é‡: ${result.collection.count}\næ¨¡å‹è®¾å¤‡: ${result.model.device || 'N/A'}`;
                } else {
                    display.textContent = `è·å–å¤±è´¥: ${result.detail}`;
                }
            } catch (error) {
                display.textContent = `é”™è¯¯: ${error.message}`;
            }
        }
        
        // æ¸…ç©ºå¯¹è¯
        async function clearChat() {
            try {
                const response = await fetch('/api/clear', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({conversation_id: currentConversationId})
                });
                
                if (response.ok) {
                    document.getElementById('chat-container').innerHTML = '';
                }
            } catch (error) {
                alert(`æ¸…ç©ºå¤±è´¥: ${error.message}`);
            }
        }
        
        // å¯¼å‡ºå¯¹è¯
        async function exportChat() {
            try {
                const response = await fetch(`/api/export?conversation_id=${currentConversationId}`);
                const result = await response.json();
                
                if (response.ok) {
                    alert(`âœ… å¯¼å‡ºæˆåŠŸ: ${result.message}`);
                } else {
                    alert(`å¯¼å‡ºå¤±è´¥: ${result.detail || result.message}`);
                }
            } catch (error) {
                alert(`é”™è¯¯: ${error.message}`);
            }
        }
        
        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('message-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶è·å–ç³»ç»Ÿä¿¡æ¯
        window.onload = function() {
            refreshSystemInfo();
        };
    </script>
</body>
</html>